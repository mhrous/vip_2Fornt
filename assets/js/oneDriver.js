let i=1;$(document).ready(function(){const{token:e,power:n}=testLogin("oneDriver");let a,t;const r={cars:[],partners:[],payment:[],expenses:[],travel:[]},s=()=>{let e;const n=$("#travel-table"),s=$("#repairing-table").DataTable({paging:!1,searching:!1}),o=e=>{console.log(e.repairing),e.repairing&&(console.log(e.repairing),e.repairing.forEach(n=>{const a=s.row.add([moment(n.date).format("YYYY-MM-DD"),n.clientName||FALSE,n.clientPhone||FALSE,` <a href="./onePartner.html?_id=${n.partner}">${r.partners.find(e=>e._id==n.partner).name}</a>`,n.from||FALSE,n.value]).draw(!1).node();$(a).addClass(`${e._id}`)}))},l=e=>{if(!e.repairing)return;s.rows(`.${e._id}`).remove().draw()},i=n.DataTable({paging:!1,searching:!1,columnDefs:[{targets:[0,1,2,3,5,6],width:"75px"}]}),d=e=>{if(0==e.length)return FALSE;let n="<div>";return e.forEach(e=>{n+=`<p> ${r.partners.find(n=>n._id==e.partner).name} : (${e.value})</p>`}),n+="</div>"},c=e=>e.cashTo+e.cashBack+e.repairing.reduce((e,n)=>e+n.value,0)-e.expenses;$("body").on("click","#travel-table .remove-table",function(){const e=$(this).data("id"),n=i.row("#"+$(this).data("id")),a=r.travel.findIndex(n=>n._id==e);swal({title:"  هل تريد حذف السفرة ",type:"info",showCancelButton:!0,confirmButtonClass:"btn-danger",confirmButtonText:"نعم",cancelButtonText:"لا"},function(t){t&&deleteTravel({id:e,success(){swal("حذف","","success"),n.remove().draw(),l(r.travel[a]),r.travel=[...r.travel.slice(0,a),...r.travel.slice(a+1)]}})})}),$("body").on("click","#travel-table .edit-table",function(){const n=$(this).data("id"),a=r.travel.find(e=>e._id==n);$("#travel-modal #modal").modal("show"),e.H_.title="تعديل  السفرة",e.H_.edit=!0,e.H_.okBtnTitle="تعديل",e.H_.partner=r.partners,e.H_.id=n,e.date=a.date,e.expenses=a.expenses,e.cashTo=a.cashTo,e.cashBack=a.cashBack,e.repairing=a.repairing});const m=e=>{r.travel=[...r.travel,e],o(e);const n=i.row.add([moment(e.date).format("YYYY-MM-DD"),e.expenses,e.cashTo,e.cashBack,d(e.repairing),c(e),renderTableAction(e._id)]).draw(!1).node();$(n).attr("id",e._id)};return(()=>{e=new Vue({el:"#travel-modal #modal",data:{H_:{title:"",okBtnTitle:"",edit:null,options:{format:"YYYY-MM-DD",useCurrent:!0}},date:null,expenses:null,cashTo:null,cashBack:null,repairing:[]},methods:{addRepairing(){this.repairing=[...this.repairing,{_id:(new Date).getTime(),partner:null,from:null,clientPhone:null,clientName:null,value:null,isGO:!0}]},removeRepairing(e){this.repairing=this.repairing.filter(n=>n._id!==e)},ok(){const e=TO_JSON(this.$data);if(delete e.H_,e.date=moment(e.date).format("YYYY-MM-DD"),(e=>e.expenses&&e.date&&!e.repairing.find(e=>!e.partner||!e.value))(e)){if(this.H_.edit){const n=this.H_.id;putTravel({id:n,data:e,success({data:e}){(({id:e,data:n})=>{r.travel=r.travel.map(a=>a._id==e?n:a);const a=r.travel.findIndex(n=>n._id==e),s=i.row("#"+e);new Date(n.date).getMonth()==new Date(t.date).getMonth()?(console.log(n.repairing,";;;;;;;;;"),l(n),o(n),s.data([moment(n.date).format("YYYY-MM-DD"),n.expenses,n.cashTo,n.cashBack,d(n.repairing),c(n),renderTableAction(n._id)]).draw(!1)):(s.remove().draw(),l(r.travel[a]),r.travel=[...r.travel.slice(0,a),...r.travel.slice(a+1)])})({data:e,id:n})},error(e){swal({title:e.responseJSON.error,type:"info",confirmButtonText:"اعد التعبئة",closeOnConfirm:!1})}})}else e.driver=a.user._id,e.car=a.car._id,addTravel({data:e,success({data:e}){new Date(e.date).getMonth()==new Date(t.date).getMonth()&&m(e)},error(e){swal({title:e.responseJSON.error,type:"info",confirmButtonText:"اعد التعبئة",closeOnConfirm:!1})}});$("#travel-modal #modal").modal("hide")}else swal({title:"بعض الحقول ناقصة",type:"warning",confirmButtonText:"اعد التعبئة",closeOnConfirm:!1})}}});const n=$("#new-travel"),s=$("#travel-modal #modal");n.on("click",()=>{s.modal("show"),e.H_.title="اضافة سفرة",e.H_.edit=!1,e.H_.okBtnTitle="اضافة",e.H_.partner=r.partners,e.date=moment().format("YYYY-MM-DD"),e.expenses=null,e.cashTo=null,e.cashBack=null,e.repairing=[]})})(),{addTravelToTable:m,clearTravelTable:()=>{s.clear().draw(),i.clear().draw(),r.travel=[]}}},o=()=>{let e;const n=$("#payment-table").DataTable({paging:!1,searching:!1});$("body").on("click","#payment-table .remove-table",function(){const e=$(this).data("id"),a=n.row("#"+$(this).data("id")),t=r.payment.findIndex(n=>n._id==e);swal({title:"  هل تريد الغاء الدفعة ",type:"info",showCancelButton:!0,confirmButtonClass:"btn-danger",confirmButtonText:"نعم",cancelButtonText:"لا"},function(n){n&&deletePayment({id:e,success(){swal("حذف","","success"),a.remove().draw(),r.payment=[...r.payment.slice(0,t),...r.payment.slice(t+1)]}})})}),$("body").on("click","#payment-table .edit-table",function(){const n=$(this).data("id"),a=r.payment.find(e=>e._id==n);$("#payment-modal #modal").modal("show"),e.H_.title="تعديل  الدفعة",e.H_.edit=!0,e.H_.okBtnTitle="تعديل",e.H_.id=n,e.date=a.date,e.amount=a.amount});const s=e=>{r.payment=[...r.payment,e];const a=n.row.add([moment(e.date).format("YYYY-MM-DD"),e.amount,renderTableAction(e._id)]).draw(!1).node();$(a).attr("id",e._id)};return(()=>{e=new Vue({el:"#payment-modal #modal",data:{H_:{title:"",okBtnTitle:"",edit:null,options:{format:"YYYY-MM-DD",useCurrent:!0}},date:null,amount:null},methods:{ok(){const e=TO_JSON(this.$data);if(delete e.H_,e.date=moment(e.date).format("YYYY-MM-DD"),(e=>e.amount&&e.date)(e)){if(this.H_.edit){const a=this.H_.id;putPayment({id:a,data:e,success({data:e}){(({id:e,data:a})=>{r.payment=r.payment.map(n=>n._id==e?a:n);const s=r.payment.findIndex(n=>n._id==e),o=n.row("#"+e);new Date(a.date).getMonth()==new Date(t.date).getMonth()?o.data([moment(a.date).format("YYYY-MM-DD"),a.amount,renderTableAction(a._id)]).draw(!1):(o.remove().draw(),r.payment=[...r.payment.slice(0,s),...r.payment.slice(s+1)])})({data:e,id:a})},error(e){swal({title:e.responseJSON.error,type:"info",confirmButtonText:"اعد التعبئة",closeOnConfirm:!1})}})}else e.user=a.user._id,addPayment({data:e,success({data:e}){new Date(e.date).getMonth()==new Date(t.date).getMonth()&&s(e)},error(e){swal({title:e.responseJSON.error,type:"info",confirmButtonText:"اعد التعبئة",closeOnConfirm:!1})}});$("#payment-modal #modal").modal("hide")}else swal({title:"بعض الحقول ناقصة",type:"warning",confirmButtonText:"اعد التعبئة",closeOnConfirm:!1})}}});const o=$("#new-payment"),l=$("#payment-modal #modal");o.on("click",()=>{l.modal("show"),e.H_.title="اضافة دفعة",e.H_.edit=!1,e.H_.okBtnTitle="اضافة",e.date=moment().format("YYYY-MM-DD"),e.amount=null})})(),{addPaymentToTable:s,clearPaymentTable:()=>{n.clear().draw(),r.payment=[]}}},l=()=>{const e=({_id:e,name:n})=>`\n    <a href="./onePartner.html?_id=${e}">${n}</a>\n    `;let n;const s=$("#expenses-table").DataTable({paging:!1,searching:!1,columnDefs:[{targets:[0,5],width:"75px"},{targets:[2,3,4,6],width:"50px"}]});$("body").on("click","#expenses-table .remove-table",function(){const e=$(this).data("id"),n=s.row("#"+$(this).data("id")),a=r.expenses.findIndex(n=>n._id==e);swal({title:"  هل تريد الغاء المصروف ",type:"info",showCancelButton:!0,confirmButtonClass:"btn-danger",confirmButtonText:"نعم",cancelButtonText:"لا"},function(t){t&&deleteExpenses({id:e,success(){swal("حذف","","success"),n.remove().draw(),r.expenses=[...r.expenses.slice(0,a),...r.expenses.slice(a+1)]}})})}),$("body").on("click","#expenses-table .edit-table",function(){const e=$(this).data("id"),a=r.expenses.find(n=>n._id==e);$("#expenses-modal #modal").modal("show"),n.H_.title="تعديل  المصروف",n.H_.edit=!0,n.H_.okBtnTitle="تعديل",n.H_.partner=r.partners,n.H_.id=e,n.date=a.date,n.amount=a.amount,n.reason=a.reason,n.onCar=a.onCar,n.onDriver=a.onDriver,n.onPartner=a.onPartner,n.partner=a.partner._id});const o=n=>{r.expenses=[...r.expenses,n];const a=s.row.add([moment(n.date).format("YYYY-MM-DD"),n.reason,n.amount,n.onCar?TRUE:FALSE,n.onDriver?TRUE:FALSE,n.onPartner?e(n.partner):FALSE,renderTableAction(n._id)]).draw(!1).node();$(a).attr("id",n._id)};return(()=>{n=new Vue({el:"#expenses-modal #modal",data:{H_:{title:"",okBtnTitle:"",edit:null,partner:r.partners,options:{format:"YYYY-MM-DD",useCurrent:!0}},date:null,amount:null,reason:"",onCar:!0,onDriver:!0,onPartner:!1,partner:null},methods:{ok(){const n=TO_JSON(this.$data);if(n.partner||delete n.partner,n.date=moment(n.date).format("YYYY-MM-DD"),delete n.H_,(e=>e.amount&&e.date&&(e.onPartner||e.onDriver||e.onCar)&&(e.onPartner&&e.partner||!e.onPartner&&!e.partner))(n)){if(this.H_.edit){const a=this.H_.id;putExpenses({id:a,data:n,success({data:n}){(({id:n,data:a})=>{r.expenses=r.expenses.map(e=>e._id==n?a:e);const o=r.expenses.findIndex(e=>e._id==n),l=s.row("#"+n);new Date(a.date).getMonth()==new Date(t.date).getMonth()?l.data([moment(a.date).format("YYYY-MM-DD"),a.reason,a.amount,a.onCar?TRUE:FALSE,a.onDriver?TRUE:FALSE,a.onPartner?e(a.partner):FALSE,renderTableAction(a._id)]).draw(!1):(l.remove().draw(),r.expenses=[...r.expenses.slice(0,o),...r.expenses.slice(o+1)])})({data:n,id:a})},error(e){swal({title:e.responseJSON.error,type:"info",confirmButtonText:"اعد التعبئة",closeOnConfirm:!1})}})}else n.driver=a.user._id,n.car=a.car._id,addExpenses({data:n,success({data:e}){new Date(e.date).getMonth()==new Date(t.date).getMonth()&&o(e)},error(e){swal({title:e.responseJSON.error,type:"info",confirmButtonText:"اعد التعبئة",closeOnConfirm:!1})}});$("#expenses-modal #modal").modal("hide")}else swal({title:"بعض الحقول ناقصة",type:"warning",confirmButtonText:"اعد التعبئة",closeOnConfirm:!1})}}});const l=$("#new-expenses"),i=$("#expenses-modal #modal");l.on("click",()=>{i.modal("show"),n.H_.title="اضافة مصروف",n.H_.edit=!1,n.H_.partner=r.partners,n.H_.okBtnTitle="اضافة",n.date=moment().format("YYYY-MM-DD"),n.amount=null,n.reason="",n.onCar=!0,n.onDriver=!0,n.onPartner=!1,n.partner=null})})(),{addExpensesToTable:o,clearExpensesTable:()=>{s.clear().draw(),r.expenses=[]}}};initSummary=(()=>{const e=$("#summary"),n=r.travel.length,t=a.car.expensesMax,s=r.travel.reduce((e,n)=>e+(n.expenses>t?1:0),0),o=r.travel.reduce((e,n)=>e+n.repairing.length,0),l=r.travel.reduce((e,n)=>e+n.cashTo+n.cashBack+n.repairing.reduce((e,n)=>e+n.value,0),0),i=r.travel.reduce((e,n)=>e+n.expenses,0),d=r.expenses.reduce((e,n)=>e+(n.onDriver?n.amount:0),0),c=(r.expenses.reduce((e,n)=>e+(n.onCar?n.amount:0),0),r.travel.reduce((e,n)=>e+n.repairing.reduce((e,n)=>e+n.value,0),0)),m=r.payment.reduce((e,n)=>e+n.amount,0),p=l-i-d-c-m;let v=0;r.travel.forEach(e=>{const n=e.repairing.reduce((e,n)=>e+(n.isGO?0:n.value),0),a=e.repairing.reduce((e,n)=>e+(n.isGO?n.value:0),0);0==e.cashTo&&0==a&&v++,0==e.cashBack&&0==n&&v++}),str=`\n    <div class="card shadow mb-3">\n    <div class="card-header">\n      <h4 style="color:  #5e72e4; text-align: center;">معلومات السائق</h4>\n    </div>\n    <div class="card-body" style="text-align: right;">\n      <div class="row">\n        <div class="col-6">\n          <div class="row mb-3">\n            <div class="col-9">\n              <h4 class="mb-3">عدد السفرات :</h4>\n            </div>\n            <div class="col-3">\n              <h4 style="color:  #5e72e4;">${n}</h4>\n            </div>\n          </div>\n          <div class="row mb-3">\n            <div class="col-9">\n              <h4 class="mb-3">عدد السفرات الفارغة :</h4>\n            </div>\n            <div class="col-3">\n              <h4 style="color:  #5e72e4;">${v}</h4>\n            </div>\n          </div>\n          <div class="row mb-3">\n            <div class="col-9">\n              <h4 class="mb-3">تجاوز المصروف الاقصى (${t}) :</h4>\n            </div>\n            <div class="col-3">\n              <h4 style="color:  #5e72e4;">${s}</h4>\n            </div>\n          </div>\n          <div class="row mb-3">\n            <div class="col-9">\n              <h4 class="mb-3">عدد ايصالات الدين :</h4>\n            </div>\n            <div class="col-3">\n              <h4 style="color:  #5e72e4;">${o}</h4>\n            </div>\n          </div>\n        </div>\n        <div class="col-6">\n          <div class="mb-3 row">\n            <div class="col-9">\n              <h4 class="mb-3">قيمة السفرات :</h4>\n            </div>\n            <div class="col-3">\n              <h4 style="color:  #5e72e4;">${l}</h4>\n            </div>\n          </div>\n          <div class="mb-3 row">\n            <div class="col-9">\n              <h4 class="mb-3">اجمالي المصروف :</h4>\n            </div>\n            <div class="col-3">\n              <h4 style="color:  #5e72e4;">${i}</h4>\n            </div>\n          </div>\n\n          <hr />\n          <div class="mb-3 row">\n          <div class="col-9">\n          <h4 class="mb-3">الاجمالي  :</h4>\n\n          </div>\n          <div class="col-3">\n            <h4 style="color:  #5e72e4;">${l-i}</h4>\n          </div>\n        </div>\n\n\n          <div class="mb-3 row">\n            <div class="col-9">\n              <h4 class="mb-3">\n                اجمالي التصليحات دفعها السائق :\n              </h4>\n            </div>\n            <div class="col-3">\n              <h4 style="color:  #5e72e4;">${d}</h4>\n            </div>\n          </div>\n  \n\n  \n          <div class="mb-3 row">\n            <div class="col-9">\n              <h4 class="mb-3">اجمالي وصول الدين :</h4>\n            </div>\n            <div class="col-3">\n              <h4 style="color:  #5e72e4;">${c}</h4>\n            </div>\n          </div>\n          <div class="mb-3 row">\n            <div class="col-9">\n              <h4 class="mb-3">اجمالي الدفعات :</h4>\n            </div>\n            <div class="col-3">\n              <h4 style="color:  #5e72e4;">${m}</h4>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n    <div class="card-footer" style="text-align:right;">\n      <div class="mb-3 row">\n        <div class="col-6"></div>\n        <div class="col-6 row">\n        <div class="col-9">\n        <h4 class="mb-3">المبلغ الواجب قبضه :</h4>\n      </div>\n      <div class="col-3">\n        <h4 style="color:  #5e72e4;">${p}</h4>\n      </div>\n        </div>\n        \n      </div>\n    </div>\n  </div>\n  \n  \n\n    `,e.html(str)});(()=>{renderSiteBar();const{addExpensesToTable:e,clearExpensesTable:n}=l(),{addPaymentToTable:i,clearPaymentTable:d}=o(),{addTravelToTable:c,clearTravelTable:m}=s();$("#tap-summary").on("click",initSummary),a=new Vue({el:"#user",data:{user:{name:""},car:null}}),t=new Vue({el:"#MainDate",data:{date:moment(new Date).format("YYYY-MM"),options:{format:"YYYY-MM",useCurrent:!0}},watch:{date(a){let[t,r]=a.split("-");r=parseInt(r),t=parseInt(t),getData({m:r,y:t,success({data:{payment:a,expenses:t,travel:r}}){d(),n(),m();for(let e of a)i(e);for(let n of t)e(n);for(let e of r)c(e);initSummary()}})}},mounted(){let[n,t]=this.date.split("-");t=parseInt(t),n=parseInt(n),getDataConst({success({data:{car:s,partners:o}}){a.user=s.driver,r.car=s,r.partners=o,a.car=s,getData({m:t,y:n,success({data:{payment:n,expenses:a,travel:t}}){for(let n of a)e(n);for(let e of n)i(e);for(let e of t)c(e);initSummary()}})}})}})})()});